#Análise de sobrevivência 


## Introdução 

Experimentos cujo tempo para a ocorrência de um evento é o objeto de interesse são comuns na epidemiologia de doenças de plantas. Por exemplo, o tempo para a ocorrência de sintomas e sinais, ou seja, o período de incubação e latência, respectivamente são componentes do monociclo com grande importancia para a descrição das epidemias. Uma das principais características de dados relacionados ao tempo é a censura a direita, ou seja, o experimento pode encerrar antes de todas as repetições apresentarem o evento, o que consiste em um resultado importante e que deve ser incorporado na análise. No entanto, a estatística clássica não é apropriada para análisar dados censurados, pois não consegue acomodar este fator na análise, o quereflete em estimativas que não são fidedignas. Dentro deste contexto, a análise de sobrevivência foi desenvolvida com técnicas não paramétricas e paramétricas. Alguns artigos da fitopatologicos tem sido publicados utilizando esta análise para estimar o período de incubação [@Copes2008],comparar de cultivares utilizando o tempo para ocorrência de sintomas, tempo para a queda de folhas sintomáticas [@Ojiambo2005], entre outros. 


Dentre as técnicas não paramétricas, o estimador Kaplan-Meier [@Kaplan1958] é o mais utilizado. O método estima a função de sobrevivência, ou seja, a probabilidade de um indivíduo não apresentar o evento decorrido um tempo "t". Os gráficos gerados por esta análise são representados por degraus de tempo em que ocorre o evento (Figura \@ref(fig:curvakaplan)). Por meio desta técnica, torna-se possível a aplicação de testes de significância, como o Log-Rank, para comparar tratamentos. O log-Rank testa a hipótese nula de que as curvas formadas são semelhantes [@Colosimo2006]. Este tipo de técnica é limitada em testar o o efeito de apenas uma covariável, representadas pelos fatores de tratamentos. Em outras palavras,  o método não permite analisar possíveis inteirações em experimentos fatoriais. 

(ref:curvakaplan) Exemplo de curva de Kaplan-Meier estimando funções de sobrevivência para a queda de folhas de mirtilo com mancha foliar de Septoria. Fonte: [@Ojiambo2005].

```{r curvaskaplan, echo=FALSE, fig.cap= '(ref:curvakaplan)'}
knitr::include_graphics("camilla/curvaskaplan.jpg")

```

Na técnica paramétrica, uma distribuição de probabilidades  precisa ser selecionada. A distribuição de Weilbull, Log-normal e exponencial são as mais utilizadas na análise de sobreviência. Esta abordagem pode ser aplicada tanto em estudos com apenas um fator (covariável), como também permite, em experimentos em esquema fatorial, determinar parâmetros importantes para analisar inteirações entre fatores [@Zhang2016]. 


Assim, o capítulo tem como objetivo executar os passos para a análise de sobrevivência no software R em dois estudos de caso que envolvem experimentos com frutos destacados (*ex vivo*) com podridões de frutos ocasionadas por espécies do gênero *Colletotrichum*. No primeiro caso, a técnica não paramétrica e paramétrica foram discutidas com base em um experimento epidemiológico com maças com apenas um fator. No segundo caso, a tecnica paramétrica utilizando a distribuição de Weibull foi aplicada para analisar um experimento fatorial com base no período de incubação da doença em caquis inoculados com diferentes espécies do patógeno e tratados com diferentes fungicidas. 

(ref:frutos) Lesões necróticas e esporulação do patógeno *Colletotrichum* spp. em frutos de maça (A) e caqui (B). Fotos: Thiago de Aguiar Carraro 

```{r frutos, echo=FALSE, fig.cap= '(ref:frutos)'}
knitr::include_graphics("camilla/frutos.jpg")

```

### Estudo de caso 1 - Técnica não paramétrica e paramétrica em experimento com um fator  

Frutos em diferentes estágios de crescimento podem apresentar diferenças na suscetibilidade a doenças [@Jiang2014; @Keske2011]. Conhecer o período de maior suscetibilidade pode auxiliar na tomada de decisão para aplicações de produtos para o controle da doença. Experimentos para avaliar a suscetibilidade podem ser realizados no campo, monitorando a incidencia de doenças em diferentes fases, ou até mesmo pela inoculação em frutos ensacados e a observação do desenvolvimento de sintomas. Para melhor segurança nos resultados, estudos em ambientes controlados, como em frutos destacados (*e vivo*) podem ser realizados. Este estudo de caso foi realizado em frutos destacados e mantidos em laboratório. A suscetibilidade foi avaliada com base em diferenças no risco para a ocorrencia de sintomas e no período de incubação, ambos estimados pela análise de sobrevivência. 

Suponha um experimento onde cinco diferentes tamanhos de maças (tam1, tam2, tam3, tam4 e tam5) foram coletados do campo. Os frutos foram desinfestados e um ferimento foi provocado na região equatorial. Uma gota de suspensão de conídios do patógeno foi depositada sobre o ferimento. Após a inoculação, os frutos foram aleatoriamente distribuidos em uma sala de incubação com condições controladas e homogeneas, constituindo um delineamento inteiramente casualisado com 5 tratamentos e 8 repetições (Figura \@ref(fig:esquema)). 


(ref:esquema) Ilustração do experimento.  

```{r esquema, echo=FALSE, fig.cap= '(ref:esquema)'}
knitr::include_graphics("camilla/esquema.jpg")

```


Após a inoculação, cada fruto foi avaliado diariamente durante 39 dias. O dia do aparecimento de sintomas foi anotado e atribuido o status "1". Nos frutos em que não apresentaram sintomas, o status "0"" foi atribuido no dia 39, constituindo a censura. Desta forma, a tabela com o conjunto de dados deste estudo só conteve o desfecho de cada fruto (\@ref(tab:conjuntodedados). No caso de tabelas que contenham o historico diário dos frutos é necessário filtrar os dados. Para isso, consultar a próxima seção.  


(ref:conjuntodedados) Conjunto de dados para análise de sobrevivência.

```{r conjuntodedados, echo=FALSE}
tb <- read.csv2 ("camilla/sobrev.csv")
knitr::kable(head(tb), caption = '(ref:conjuntodedados)',
             digits = c(1, 1, 1, 1),
             align = c("cccc"),
             row.names = FALSE)
```

Na sequência, os passos para a técnica não paramétrica foram demonstrados.Neste passo, a função de sobrevivencia, teste de log rank foram executados. O risco para a ocorrência de sintomas também foi determinada pela modelagem da sobrevivência (Modelo semi-paramétrico de Box-Cox). 

```{r, message=FALSE}
#Carrega pacotes

library(tidyverse)
library(survival)
library(emmeans)
library(survival)
#Leitura dos dados

dados  <-  read.csv2("camilla/sobrev.csv")

#Análises exploratórias 

#Curvas de densidade ao longo dos dias em diferentes tamanho
ggplot(data = dados,
       mapping = aes(x = day, color = tamanho)) +
  geom_density() +
  geom_rug() +
  facet_wrap(facets = ~ status)

#quantidade de frutos com sintomas nos difentes tamanhos
ggplot(data = dados,
       mapping = aes(x = tamanho, y = day, color = tamanho)) +
  geom_jitter(width = 0.1) +
  stat_summary(mapping = aes(group = tamanho), geom = "line", fun.y = mean)

# Gráfico com a linha do day de cada fruto que mostra quando o evento
# aconteceu e que tipo de desfecho.

dados0 <- dados %>%
  group_by(tamanho) %>%
  arrange(day) %>%
  mutate(ord = seq_along(day)/n())


ggplot(data = dados0,
       mapping = aes(x = day, y = ord, shape = factor(status))) +
  facet_grid(~tamanho) +
  geom_point() +
  geom_segment(mapping = aes(x = 0, y = ord, xend = day, yend = ord)) +
  scale_shape_manual(breaks = c(0, 1),
                     values = c(1, 19),
                     labels = c("Censura", "Sintoma")) +
  labs(shape = "Desfecho",
       x = "Dias após inoculação",
       y = "Ordem do fruto") +
  scale_x_continuous(breaks = seq(0, max(dados$day), by = 5))

# Técnica não paramétrica

# estimar funções de sobrevivencia

(s   <- survfit(Surv(day, status)~ tamanho, data=dados))

#Curva de Kaplan Meier
library(survminer)

fit <- survfit(Surv(day, status) ~ tamanho, data = dados)
ggsurvplot(fit, data = dados, censor.shape="|", censor.size = 4)

#calcula o teste de log-rank

survdiff(Surv(day, status)~ tamanho, data=subset(dados))

#ajusta os parÃ¢metros do modelo de regressÃ£o de Cox

fit <- coxph(Surv(day, status) ~ tamanho, data=dados)
summary(fit)

```

Os passos para a técnica paramétrica foram relacionados a seguir. Neste caso, o período de incubação foi obtido e comparado entre os tratamentos, ou seja, entre tamanhos de frutos. 

```{r, message=FALSE}
#Técnica não paramétrica 

#carrega pacotes
library(tidyverse)
library(survival)
library(emmeans)

# Ordena pelo dia do evento dentro de cada unidade experimental.
dados <- dados %>%
  group_by(tamanho) %>%
  arrange(day) %>%
  mutate(ord = seq_along(day)/n())

s <- with(dados,
            Surv(time = day,
                 event = status))
  
  # Modelo nulo que não tem efeito de nenhum fator.
  m0 <- survreg(formula = s ~ 1,
                data = dados,
                dist = "weibull")
  
  # Inclui o efeito de espécie.
  m1 <- survreg(formula = s ~ tamanho,
                data = dados,
                dist = "weibull")
  
 # Teste da razão de verossimilhanças entre modelos encaixados.
  anova(m0, m1)
  
  mx <- m1 
  
   # Médias ajustadas (é na interpretação do parâmetro da Weibull).
  emm <- emmeans(mx,
                 specs = ~tamanho)
  emm  
  
  tb_emm <- as.data.frame(emm)
  
  # Estimativas conforme parametrização da {p, d, q, r}weibull.
  a <- 1/mx$scale          # shape.
  b <- exp(tb_emm$emmean)  # scale.
  
  # Obtenção do day médio (é uma função complexa dos dois parâmetros).
  tb_emm$mean_day<- b * gamma(1 + 1/a)
  tb_emm
  
  tb_curves <- tb_emm %>%
    group_by(tamanho) %>%
    do({
      day <- seq(0, 20, length.out = 51)
      dens <- dweibull(day, shape = a, scale = exp(.$emmean))
      accu <- pweibull(day, shape = a, scale = exp(.$emmean))
      data.frame(day, dens, accu)
    }) %>%
    ungroup()
  
  # As curvas de densidade ajustadas.
  ggplot(data = tb_curves,
         mapping = aes(x = day, y = dens)) +
    facet_grid(facets =  ~ tamanho) +
    geom_line()  
  
  # As curvas de "1 - sobreviência".
  ggplot(data = tb_curves,
         mapping = aes(x = day, y = accu)) +
    facet_grid(facets = ~ tamanho) +
    geom_line() 

  
  # Valores observados com sobreposição das curvas ajustadas.
  ggplot(data = dados,
         mapping = aes(x = day, y = ord, shape = factor(status))) +
    facet_grid(facets = ~ tamanho) +
    geom_point() +
    scale_shape_manual(breaks = c(0, 1),
                       values = c(1, 19),
                       labels = c("Censura", "Sintoma")) +
    labs(shape = "Desfecho",
         x = "Dias após inoculação",
         y = "Frequência acumulada") +
    geom_vline(data = tb_emm,
               mapping = aes(xintercept = mean_day),
               color = "orange") +
    geom_line(data = tb_curves,
              inherit.aes = FALSE,
              mapping = aes(x = day, y = accu))
  
   #Comparando os tratamentos
  
  emm_tamanho_in <- emmeans(mx, specs = ~tamanho)
  emm_tamanho_in
 
  
  
   # contrast(emm_trat_in, method = "pairwise")
  library(multcomp)
  tamanho_in_comp <- multcomp::cld(emm_tamanho_in)
  tamanho_in_comp  
  
  # Tabela com o resultado das comparações múltiplas.
  tb_contr <- as.data.frame(tamanho_in_comp)
  tb_contr
  
  # Transformar os números para letras e ordenar as letras conforme as
  # estimativas.
  f <- function(x) {
    l <- x %>%
      str_trim() %>%
      str_split("") %>%
      flatten_chr() %>%
      as.integer()
    str_c(letters[l], collapse = "")
  }
  f(" 123 ")  
  
  # Acerta a representação da significância dos contrastes com letras.
  tb_contr <- tb_contr %>%
    mutate(let = map_chr(.group, f)) %>%
    group_by() %>%
    mutate(let = let, means = emmean)
  
  ggplot(data = tb_contr,
         mapping = aes(x = tamanho, y = emmean)) +
    
    geom_point() +
    geom_errorbar(mapping = aes(ymin = lower.CL,
                                ymax = upper.CL),
                  width = 0.05) +
    geom_text(mapping = aes(label = sprintf("%0.2f %s",
                                            emmean,
                                            let)),
              hjust = 0.5,
              vjust = -1,
              angle = 90,
              nudge_x = 0.075) +
    labs(x = "Tratamento",
         y = "Estimativa do parâmetro de locação")  
  

```

