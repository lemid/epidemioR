# Análise de sobrevivência ultilizando modelo de regressão paramétrico

## MOTIVAÇÃO
```{r, echo = FALSE, results = "asis"}
chapter_authors(c("Thiago de Aguiar Carraro", "Paulo dos Santos Faria Lichtemberg", "Camilla Castellar", "Walmes Marques Zeviani", "Louise Larissa May De Mio"))
```

<!--  (Figura \@ref(fig:prancha-1)). -->

<!-- (ref:prancha-1) Lesões necróticas, deprimidas, escuras e circulares em frutos imaturo no campo (A), evolução do sintoma em fruto imaturo destacado (B), e a acentuada queda prematura dos frutos de caquizeiro (C). Lesões em frutos maduros no campo (D) e destacado (E)(com massa de conídios no centro da lesão). Lesões típicas de antracnose em ramos jovens (F). -->

<!-- ```{r prancha-1, echo = FALSE, fig.cap= '(ref:prancha-1)'} -->
<!-- knitr::include_graphics("./tac/prancha_1.jpg") -->
<!-- ``` -->

O controle químico é uma das formas mais eficientes para o controle de doenças de plantas, porém alguns fungicidas de sítios específicos apresentam riscos de médio a alto, como os IDMs (inibidores da desmetilação) e IQes (inibidores da quinona externa), respectivamente, para selecionar resistências no patógeno e, consequentemente podem resultar em uma perda da eficiência em campo, caso os mesmos não sejam adequadamente manejados. Para adotar estratégias de controle eficientes ao longo das safras é necessário que seja realizado o monitoramento da sensibilidade do fungo aos fungicidas [@lichtemberg2016].

Os ensaios *in vitro* de DD (dose discriminatória), CE~50~ (concentração efetiva que inibe 50% do crescimento ou germinação do patógeno), CMI (concentração mínima inibitória), e com valores de diferentes isolados e de diferentes anos, podem ser usados para comparar se está ocorrendo uma mudança na sensibilidade do patógeno ao fungicida, como observado em isolados de *Monilinia fructicola* [@russell; @maydemio2011]

Ensaios *ex vivo* são também relevantes para determinar uma possível resistência prática de um fungicida no controle de um patógeno, ou seja, quando ocorre uma falha do controle da doença em campo [@ghinirekimatih2000]. Estes testes podem ser realizados com plantas ou partes vegetais destacados, que serão submetidos a um tratamento com a concentração recomendada para o produtor.
Uma vez detectada a mudança de sensibilidade em populações de patógenos, novas recomendações e estratégias para o uso de fungicidas devem ser adotadas.

Diante disso, considera-se um experimento em laboratório com frutos destacados como exemplo desse teste, cujo o objetivo foi avaliar diferentes tratamentos (fungicidas) para o controle de duas espécies de *Colletotrichum*, que causam uma séria doença na cultura do caquizeiro. O experimento foi conduzido em esquema fatorial duplo, com condições ambientais favoráveis ao patógeno 25^{o}C \pm 2 , seis tratamentos foram testados, sendo cinco fungicidas (A, B, C, E, D) e uma testemunha (T) com água, duas espécies patogênicas (X e Y) foram analisadas, cada espécie/tratamento contou com 25 repetições, e o experimento foi realizado duas vezes. Os frutos foram tratados com os produtos previamente, e após 24 horas foram inoculados com as espécies fúngicas. Em relação as avaliações, durante um total de 10 dias, diariamente foi analisado se existia a presença ou não de lesão (sintomas) nos frutos, caso observado a repetição/tratamento/espécie era anotado a incidência como valor (1), caso contrário era marcado como (0). Sendo assim, quando metade ou mais das repetições/tratamentos (13 frutos) apresentavam o sintoma da doença, este foi determinado o período de incubação (PI). Para a análise estatística, os dados do aparecimento dos primeiros sintomas da doença ao longo do tempo do experimento, relacionando com a eficiência dos fungicidas X patógenos , bem como o PI para cada fator, serão estimados por modelos de regressão paramétricos de estudos de sobrevivência (Weibull), utilizando o auxílio do software Rstudio [@R].

## Modelo de Regressão Weibull (INSERIR ESTA PARTE NA INTRODUÇÃO GERAL - CAMILLA)

```{r, message=FALSE}
# Pacotes.

rm(list = objects())

library(tidyverse)
library(survival)
library(emmeans)

# Será usada a `ordered_cld()`.
url <- "https://raw.githubusercontent.com/walmes/wzRfun/master/R/pairwise.R"
source(url)


# -------------------------------------------------------------------------

# Importação dos dados e preparação.

# Análise dos dados (leitura).
da <- read_tsv("tac/frutosmaduros.txt")
attr(da, "spec") <- NULL
str(da)

# Tabela de frequência cruzada.
xtabs(~spp + fung, data = da)

# Existe NA em algum lugar?
u <- !complete.cases(da)
sum(u)
da[u, ]

# # Substitui o NA por censura a direita.
# da <- da %>%
#   replace_na(replace = list(status = 0))

# Criar fatores.
da <- da %>%
  mutate(fung = factor(fung),
         spp = factor(spp),
         ue = interaction(fung, spp, rep))

# A tabela contém o registro dia após dia de cada unidade 
#experimental. O evento ocorre quando o variável `status` troca de valor
# 0 para 1.
da %>%
  filter(ue == levels(ue)[1])

# Determina a primeira data de valor `status == 1` para cada unidade
# experimental.
da_1 <- da %>%
  group_by(ue) %>%
  filter(status == 1) %>%
  top_n(day, n = -1)
da_1

# Determina a última data de valor `status == 0` para cada unidade
# experimental restante, ou seja, que não apresentou `status == 1`.
da_0 <- anti_join(da, da_1, by = "ue") %>%
  group_by(ue) %>%
  top_n(day, n = 1)
da_0

# Junta as duas porções.
da_final <- bind_rows(da_1, da_0) %>%
  ungroup()
da_final

xtabs(~fung + spp, data = da_final)

xtabs(status ~ fung + spp, data = da_final)

# Verifica.
da_final %>%
  filter(spp == "Ch", fung == "mythos") %>%
  print(n = Inf)


# -------------------------------------------------------------------------

# Análise exploratória.

str(da_final)

# Ordena pelo dia do evento dentro de cada unidade experimental.
da_final <- da_final %>%
  group_by(spp, fung) %>%
  arrange(day) %>%
  mutate(ord = seq_along(day)/n())

# Gráfico com a linha do tempo de cada fruto que mostra quando o evento
# aconteceu e que tipo de desfecho.

ggplot(data = da_final,
       mapping = aes(x = day, y = ord, shape = factor(status))) +
  facet_grid(facets = spp ~ fung) +
  geom_point() +
  geom_segment(mapping = aes(x = 0, y = ord, xend = day, yend = ord)) +
  scale_shape_manual(breaks = c(0, 1),
                     values = c(1, 19),
                     labels = c("Censura", "Sintoma")) +
  labs(shape = "Desfecho",
       x = "Dias após inoculação",
       y = "Ordem do fruto") +
  scale_x_continuous(breaks = seq(0, max(da_final$day), by = 2))


# ATENÇÃO -----------------------------------------------------------------

# Será feita análise de sobreviência com esses dados pois é motivada
# pelo tipo de resposta de natureza "tempo até desfecho". Para acomodar
# a estrutura de planejamento fatorial completo 2 x 6, será usada uma
# abordagem paramétrica. Por apresentar boa flexibilidade, será usada a
# distribuição Weibull para o tempo até o desfecho. Com isso consegue-se
# acomodar a censura e a estrutura experimental.


# -------------------------------------------------------------------------

# Antes de ir para o ajuste da Weibull, vamos reconhecer a
# parametrização.

# Gera números aleatórios de uma distribuição Weibull.

y <- rweibull(n = 1000, shape = 4, scale = 2)
plot(ecdf(y))

# Ajusta o modelo com a `survreg()`.
library(SurvRegCensCov)
m <- survreg(formula = Surv(time = y) ~ 1, dist = "weibull")
summary(m)

# Compreende os coeficientes estimados.
exp(coef(m)) # scale = exp(coef) -> 2.

1/m$scale    # shape = 1/m$scale -> 4.

# Verifica o ajuste com obsevado vs ajustado.
plot(ecdf(y))
curve(pweibull(x, shape = 1/m$scale, scale = exp(coef(m))),
      add = TRUE,
      col = 2)

# Obtenção do tempo médio.
a <- 1/m$scale
b <- unname(exp(coef(m))[1])
c("sample_mean" = mean(y),
  "estimated_mean" = b * gamma(1 + 1/a))


# -------------------------------------------------------------------------

# Ajustar a Weibull acomodando a estrutura experimental.

# COMENTÁRIO: a análise de sobrevivência é a abrodagem mais adequada para
# análise destes dados, visto que de fato a variável resposta é o tempo
# para o desfecho e tem-se censura.

# A modelagem é para a variável aleatória `tempo para aparecimento de
# sintoma` (desfecho).

s <- with(da_final,
          Surv(time = day,
               event = status))

# Modelo nulo que não tem efeito de nenhum fator.
m0 <- survreg(formula = s ~ 1,
              data = da_final,
              dist = "weibull")

# Inclui o efeito de espécie.
m1 <- survreg(formula = s ~ spp,
              data = da_final,
              dist = "weibull")

# Inclui o efeito de espécie e fungamentos (aditivo).
m2 <- survreg(formula = s ~ spp + fung,
              data = da_final,
              dist = "weibull")

# Inclui o efeito de espécie e fungamentos com interação.
m3 <- survreg(formula = s ~ spp * fung,
              data = da_final,
              dist = "weibull")

# Teste da razão de verossimilhanças entre modelos encaixados.
anova(m0, m1, m2, m3)


# O modelo com interação é o mais apropriado para descrever o tempo para
# o aparecimento de sintomas. Portanto, existe interação entre espécies
# e produtos ao nível de 5% pelo teste da deviance entre modelos
# encaixados.

# Modelo final.
mx <- m3


# -------------------------------------------------------------------------
# Extração dos tempos médios e confecção das curvas de sobrevivência.

# Médias amostrais (que ignoram estrutura e censura).
# da_final %>%
#     group_by(spp, fung) %>%
#     summarise(m_day = mean(day))

# Médias ajustadas (é na interpretação do parâmetro da Weibull).
emm <- emmeans(mx,
               specs = ~spp + fung)
emm

tb_emm <- as.data.frame(emm)

# Estimativas conforme parametrização da {p, d, q, r}weibull.
a <- 1/mx$scale          # shape.
b <- exp(tb_emm$emmean)  # scale.

# Obtenção do tempo médio (é uma função complexa dos dois parâmetros).
tb_emm$mean_day <- b * gamma(1 + 1/a)
tb_emm

# Curvas de probabilidade de desfecho.
tb_curves <- tb_emm %>%
  group_by(spp, fung) %>%
  do({
    day <- seq(0, 20, length.out = 51)
    dens <- dweibull(day, shape = a, scale = exp(.$emmean))
    accu <- pweibull(day, shape = a, scale = exp(.$emmean))
    data.frame(day, dens, accu)
  }) %>%
  ungroup()

# As curvas de densidade ajustadas.
ggplot(data = tb_curves,
       mapping = aes(x = day, y = dens)) +
  facet_grid(facets = spp ~ fung) +
  geom_line()

# As curvas de "1 - sobreviência".
ggplot(data = tb_curves,
       mapping = aes(x = day, y = accu)) +
  facet_grid(facets = spp ~ fung) +
  geom_line()

# Valores observados com sobreposição das curvas ajustadas.
ggplot(data = da_final,
       mapping = aes(x = day, y = ord, shape = factor(status))) +
  facet_grid(facets = spp ~ fung) +
  geom_point() +
  scale_shape_manual(breaks = c(0, 1),
                     values = c(1, 19),
                     labels = c("Censura", "Sintoma")) +
  labs(shape = "Desfecho",
       x = "Dias após inoculação",
       y = "Frequência acumulada") +
  geom_vline(data = tb_emm,
             mapping = aes(xintercept = mean_day),
             color = "orange") +
  geom_line(data = tb_curves,
            inherit.aes = FALSE,
            mapping = aes(x = day, y = accu))


# -------------------------------------------------------------------------

# Fazendo o estudo da interação com desdobramento com testes para o
# parâmetro de locação.

# Estudar produtos em cada espécie.
emm_fung_in <- emmeans(mx, specs = ~fung | spp)
emm_fung_in

# contrast(emm_fung_in, method = "pairwise")
fung_in_comp <- multcomp::cld(emm_fung_in)
fung_in_comp

# Tabela com o resultado das comparações múltiplas.
tb_contr <- as.data.frame(fung_in_comp)
tb_contr

# Transformar os números para letras e ordenar as letras conforme as
# estimativas.
f <- function(x) {
  l <- x %>%
    str_trim() %>%
    str_split("") %>%
    flatten_chr() %>%
    as.integer()
  str_c(letters[l], collapse = "")
}
f(" 123 ")

# Acerta a representação da significância dos contrastes com letras.
tb_contr <- tb_contr %>%
  mutate(let = map_chr(.group, f)) %>%
  group_by(spp) %>%
  mutate(let2 = ordered_cld(let = let, means = emmean))

ggplot(data = tb_contr,
       mapping = aes(x = fung, y = emmean)) +
  facet_wrap(facets = ~spp) +
  geom_point() +
  geom_errorbar(mapping = aes(ymin = lower.CL,
                              ymax = upper.CL),
                width = 0.05) +
  geom_text(mapping = aes(label = sprintf("%0.2f %s",
                                          emmean,
                                          let2)),
            hjust = 0.5,
            vjust = -1,
            angle = 90,
            nudge_x = 0.075) +
  labs(x = "fungicidas",
       y = "Estimativa do parâmetro de locação")

```

