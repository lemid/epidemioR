# Métodos para a determinação da Sensibilidade de fungos patogênicos a fungicidas  

```{r, echo FALSE, results = "asis"}
##---------------------------------------------------------------
chapter_authors(c("Paulo dos Santos Faria Lichtemberg",
                  "Thiago Aguiar Carraro",
                  "Gabriel Torres-Londoño",
                  "Walmes Marques Zeviani"))
```

## Introdução

As infecções fúngicas são a causa biótica mais comum de doenças em plantas. Desde os primórdios da agricultura, o uso de compostos antifúngicos tem ajudado a humanidade a salvar suas colheitas, mas algumas vezes essas ferramentas não funcionam como esperado porque: o produto errado foi aplicado, a quantidade errada foi aplicada, o produto foi aplicado no momento errado ou, o mais crítico, o patógeno alvo se tornou resistente ao pesticida.
A história dos fungicidas modernos ocorreu na Europa, algumas décadas depois que a **Phytophthora infestans** causou uma das fomes mais devastadoras da história, resultando no início da fitopatologia. Em 1885, o professor Pierre Alexis Millardet, estava estudando o míldio em uvas (**Plasmopara viticola**), quando notou que um vinhedo em Bordeaux – França com uma substância azulada aplicada em seu dossel não foi afetado pelo patógeno. Ele estudou a mistura e descobriu que a mistura de 8-8-100 de sulfato de cobre, cal hidratada e água pode controlar com sucesso o patógeno sem afetar as videiras; este composto é conhecido como mistura de Bordeaux ou Calda Bordalesa @[Agrios]. É considerado o primeiro fungicida moderno e seu uso continua desde sua descoberta.
Os fungicidas desenvolvidos por pelo menos 60 décadas após a descoberta da mistura de Bordeaux, eram multissítios. Após a segunda guerra mundial, muitos desenvolvimentos tecnológicos foram feitos em torno da palavra. No início da década de 1970, a descoberta do fungicida de sítio único (sintético) aconteceu como uma das chaves para o desenvolvimento da “Revolução Verde”. No entanto, o aparecimento de resistência e o fracasso no controle de alguns fungos seguiram rapidamente sua descoberta.
Alguns dos fungicidas multissítios como Hidrocabonetos Aromáticos, Organomerculários e Dodine apresentaram algum grau de redução no controle fúngico. No entanto, isso acontece apenas 20, 40 e 10 anos após o uso, respectivamente @[Leadbeater2019a]. Todos eles eram fungicidas multissítios. Em contraste, em 1970 foi detectada resistência total aos Benzimidazóis, apenas dois anos após seu lançamento. A lista de resistência de modo único de ação aumentou ao longo do tempo. Isso forçou a criação do grupo multidisciplinar do Comitê de Ação de Resistência a Fungicidas – FRAC @[Leadbeater2019b].
Os mesmos autores, @[Leadbeater2019a] classificam a resistência em 3 estágios: resistência de laboratório, campo e prática. O primeiro é limitado a isolados obtidos em condições experimentais sem muita taxa de sucesso em condições normais de campo. A segunda, é resultado de processo mutagênico natural, mas a taxa de resistência é baixa e não tem implicações no manejo da doença. A terceira é o resultado da seleção de indivíduos resistentes em condições de campo, tornando-se prevalentes e atingindo níveis de infecções acima do limite econômico. O rápido desenvolvimento da resistência obrigou aos fitopatólogos a buscar não apenas alternativas para o controle da doença, mas também técnicas para avaliar a resistência e desenvolver técnicas para mitiga-la.
Uma das abordagens comuns para estudar a resistência é determinar a linha de base da seletividade do fungicida. @[Russell2002] o define como um perfil de sensibilidade do fungo alvo ao fungicida usando técnicas biológicas ou de biologia molecular para avaliar a resposta de indivíduos ou populações fúngicas previamente não expostas ao fungicida. Este processo é mais fácil em fungos não obrigatórios que podem ser cultivados em meios artificiais.
A primeira abordagem para testes laboratoriais de resposta a fungicidas foi feita por Reddick e Wallace em 1910. Eles avaliaram a germinação de esporos, pulverizando-os em uma lâmina de microscópio @[PascheGudmestad2019]. Em seguida, foi desenvolvida a técnica de meios de cultura alterados, que permitiu avaliar vários indivíduos e doses múltiplas com uma boa taxa de repetibilidade @[PascheGudmestad2019]. No entanto, não era adequado para parasitas obrigatórios.
Para desenvolver o teste de cultura alterada, é necessário considerar a natureza do patógeno e a natureza do fungicida. Alguns patógenos crescem melhor em meio líquido enquanto outros crescem melhor em meio sólido. Alguns fungicidas inibem a germinação de esporos, enquanto outros inibem o crescimento ou esporulação de micélios. Reconhecer a natureza do fungicida é fundamental para realizar um experimento adequado.
Neste capítulo, serão tratadas as três metodologias para realizar teste de sensibilidade a fungicidas. Onde, dois patógenos obrigatórios, **Colletotrichum fioriniae** e **Alternaria alternata** foram testados em diferentes meios sólido de cultura e fungicidas.


## Método linear para determinação convencional da sensibilidade de fungos a fungicida  

Neste primeiro roteiro apresentado, tem-se por objetivo determinar a concentração efetiva de diferentes fungicidas inibidores de succinato-desidrogenase, para inibir em 50% (CE~50~) o crescimento de colônias de  **Alternaria alternata**. Aqui serão apresentados os passos necessários para a determinação dos valores de sensibilidade de 12 isolados selecionados aleatoriamente, que fizeram parte de estudos preliminares que resultaram na publicação de @[Lichtemberg2018]. Para maior transparência, segue uma breve descrição deste ensaio laboratorial. Isolados foram coletados de folhas de pistache cultivados comercialmente no Vale Central da California, nos Estados Unidos, durante o ano de 2015. As colônias foram obtidas pelo método de isolamento direto e indireto, a partir de suas estruturas produzidas sobre a lesão @[Alfenas2007] ou com a técnica da incubação por congelamento noturno, do inglês 'Overnight freezing incubation technique - ONFIT' desenvolvido por @[Pryor2002] (Figura \@ref(fig:figura1)). Em seguida, as colônias obtidas foram purificadas. Colônias monospóricas crescidas em batata dextrose ágar (BDA) tiveram discos de micélios medindo 5 mm de diâmetro transferidos para o centro de placas Petri contendo Yeast extract-bactopeptone-sodium acetate (YBA) preparadas com diferentes doses de fungicidas. Discos de micélio foram colocados em contato direto com o meio de cultura contendo fungicida. As seguintes doses e repetições foram utilizadas por isolado: 0 µg/ml (controle com duas placas); 0,01 µg/ml (duas placas); 0,05 µg/ml (uma placa); 0,1 µg/ml (duas placas); 0,5 µg/ml (uma placa); 1 µg/ml (duas placas); 10 µg/ml (uma placa); 50 µg/ml (duas placas) e 100 µg/ml (uma placa). Os ingredientes ativos testados foram, boscalida, fluopirame, fluxapiroxade e pentiopirade. Após incubação de sete dias a 24^o^C, dois diâmetros perpendiculares das colônias foram tomados em milímetros. Dados obtidos incluíram o tamanho do disco de micélio e foram anotados sem a pontuação dos valores decimais, por exemplo: uma medida em milímetros de 20,15 foi computado como 2015.

(ref:figura1) Tecido foliar de pistache apresentando infecções naturais de onde isolados foram obtidos pelo método direto (A) e método indireto, com isolados obtidos de infecções latentes estimuladas com o uso da técnica ONFIT (B).

```{r figura1, echo = FALSE, fig.cap= '(ref:figura1)'}
knitr::include_graphics("paulo/figura1.tif")
```

Agora que uma breve descrição da metodologia já foi realizada, pode-se iniciar o detalhamento do roteiro que permitirá o cálculo dos valores de CE~50~. Para isso, os seguintes pacotes deverão ser instalados: 'lattice', 'latticeExtra', 'grid', 'doBy', 'multicomp', 'MASS' and 'devetools'.

```{r, message = FALSE}
##----------------------------------------------------------------------------      
## Pacotes     

pkg <- c("lattice", 
         "latticeExtra",
         "grid",
         "doBy", 
         "multcomp",
         "MASS", 
         "devtools")

sapply(pkg, library, character.only=TRUE, logical.return=TRUE)

```

Além da seleção do diretório e carregamento do arquivo de dados, os seguintes comandos descrevem as edições necessárias para iniciarmos as estimativas de CE~50~.
No aquivo de dados (ref:dado1), faz necessário a transformação para 'fator' das colunas 'iso' (isolado), 'fun' (fungicida) e 'dos' (dose), devem ser realizados para tê-los como variáveis independentes. As colunas 'd1' e 'd2', representando os valores de ambos diâmetros da colônia, necessitam ser transformadas para valores numéricos, colocados na escala correta de medida de crescimento (mm), subtraindo-se o tamanho do disco de micélio inicial. Ainda neste grupo de comando, insere-se duas novas colunas para expressar o crescimento médio da colônia e uma nova codificação para separar o mesmo isolado testado para diferentes ingredientes ativos. Aqui remove-se dados perdidos durante a condução do estudo, identificados no banco de dados como 'NA'.

```{r dados1, echo = FALSE}
d1 <- read.txt("paulo/dados1.txt")
knitr::kable(head(d1, n = 10),
             caption = '(ref:dados1)',
             digits = c(0, NA, 2, 0, 0, 0),
             align = c("cccccc"),
             row.names = FALSE)
```

```{r, message = FALSE}
##----------------------------------------------------------------------------      
## Seleção de diretório

#setwd()
list.files(pattern="*.txt")


##----------------------------------------------------------------------------      
## Carregamento do arquivo de dados 

da <- read.table("dados1.txt", header=TRUE,
                   sep="\t", dec=".", stringsAsFactors=FALSE)

##----------------------------------------------------------------------------      
## Edições de dados

str(da)

da <- transform (da,
                iso=factor(iso),
                fun=factor(fun), 
                dos=as.numeric(dos),
                d1=as.numeric(d1),
                d2=as.numeric(d2))

da <- transform (da,
                d1=(d1/100)-5,
                d2=(d2/100)-5)

da$cod <- with(da, interaction(iso, fun, sep="-", drop=TRUE))
da$cre = apply(da[,c(5:6)],1,mean)

str(da)
head(da, 100)

##----------------------------------------------------------------------------      
## Remoção de dados perdidos      

sum(is.na(da$cre)) 
da <- droplevels(da[complete.cases(da$cre),])
nlevels(da$iso)

```

Após a edição inicial dos dados, passa-se a separar a tabela pelo identificador 'cod' que codifica a combinação entre isolado e ingrediente ativo testado. Também se faz necessário estabelecer o crescimento médio (ao máximo de crescimento) obtido em cada dose relativa ao controle 'crerel'. Logo, separamos a tabela com crescimento e dose maiores que zero. Finalizando este grupo de comandos, alguns ajustes finais são realizados para o cálculo da sensibilidade.

```{r, message = FALSE}
##----------------------------------------------------------------------------      
## Identificador 'cod' e Crescimento Relativo 'crerel' 

das <- split(da, f=da$cod)

das <- lapply(das,
                function(i){
                    mx <- max(i$cre[i$dos==0])#, na.rm=TRUE 
                    transform(i, crerel=cre/mx,
                              ld=log10(dos))
                })

db <- lapply(das, subset, subset=cre>0 & dos>0)

##----------------------------------------------------------------------------
# Número de observações para cada subgrupo
nd <- sapply(db, nrow)
# Subgrupo com n igual a zero
iz <- nd==0
# Não é possível ter quaisquer valor zero
sum(iz)
# Esvaziar subgrupo
db[iz]                 
# Limpa
db <- db[!iz]        
dbs <- do.call(rbind, db)

```

Antecipando-se ao cálculo dos valores da sensibilidade, os seguintes grupos de comandos estabelecem dados estatísticos que indicarão a validade das regressões lineares e apontarão a necessidade de ajustes nas doses utilizadas para a realização do estudo final.  

```{r, message = FALSE}
##----------------------------------------------------------------------------      
## Valores de regressões lineares e probabilidades de significância

regs <- lapply(db, lm, formula=crerel~ld)
head(regs)
#mostra os valores de 'a' e 'b' da equação da reta
sapply(regs, coef)
#mostra os valores de coeficiente de determinação (r^2)
sapply(regs, function(cod) summary(cod)$r.squared)
#mostra os valores de equação da reta com r^2 e probabilidades de significância  
lapply(regs, function(cod) summary(cod))
#mostra os valores de significância da regressao para Log(dose) de forma resumida
reg_info <- lapply(regs, function(cod) summary(cod)$coeff)
#reg_info
```
Finalmente, chega-se ao curto grupo de comando que determinará os valores de sensibilidades para os 12 isolados testados para quatro diferente ingrediente ativos. 

```{r, message = FALSE}
##----------------------------------------------------------------------------      
## Cálculo dos valores de sensibilidade

ec50 <- sapply(regs,
               function(cod){
                   b <- coef(cod)
                   10^((0.5-b[1])/b[2])
               })

str(ec50)
head(ec50,5)
```

Para facilitar a transferência de dados calculados, adiciona-se os comandos abaixo que permitirão transferir para dentro do diretório selecionado inicialmente uma tabela de Microsoft Excel contendo os valores de sensibilidade para cada combinação entre isolado e ingrediente ativo em formato comma-separated velues (csv).  

```{r, message = FALSE}
##----------------------------------------------------------------------------      
## Criar uma tabela em excel (*.csv) com os valores calculados de sensibilidade

write.csv(ec50, 'valores_de_sensibilidade_estimados.csv')

```

Antes de finalizar este roteiro, indica-se o uso de uma figura exploratória para observar as curvas obtidas neste exercício onde se identifica os diferentes ingredientes ativos com diferentes cores (Figura \@ref(fig:figura2)).

(ref:figura2) Crescimento relativo (crerel) em função de doses de fungicidas em escala logaritmica, para 12 isolados de **Alternaria alternata**, onde cores identificam diferentes ingredientes ativos testados. 

```{r figura2, echo = FALSE, fig.cap= '(ref:figura2)'}
knitr::include_graphics("paulo/figura2.png")
```

```{r figure2, echo = FALSE, fig.cap = '(ref:figure2)'}
##----------------------------------------------------------------------------      
## Figura Exploratória

str(dbs)
xyplot(crerel~ld|cod, group=fun, data=dbs, type=c("p","r"), strip=FALSE)

```

## Método de gradiente espiral para determinação da sensibilidade a fungicidas

Antes de iniciar o detalhamento do método seguinte, cabe uma breve descrição das etapas que antecedem a coleta de dados, utilizando-se do método de gradiente espiral. Para este estudo, duas populações de **Colletotrichum fiorinae**, uma exposta (EX) e outra não exposta (BL) a inibidores de succinate-dehidrogenase, foram comparadas quanto aos seus valores de sensibilidade a dois ingredientes ativos, bezovindiflupir e fluopirame. Ao invés de utilizar o método convencional de múltiplas placas de Petri, utilizou-se uma única placa de 150 mm de diâmetro contendo 50 ml de meio de cultura YBA. Com o auxílio do equipamento Eddy Jet 2W - Spiral Plater (Neutec Group Inc, Farmingdale, NY, USA), soluções estoque de fungicidas preparados a 100 e 1.000 µg/ml foram aplicados em função exponencial, na superfície solidificada do meio de cultura, no qual foram mantidas por 6 horas, dentro de uma câmera de fluxo, para permitir correta difusão do produto químico no meio de cultura. Para a utilização do equipamento, recomenda-se seguir as intruções do fabricante. Isolados a serem testados foram cultivados sobre palitos de madeira duplamente autoclavados e medindo 5 cm de comprimento por 6 mm de largura. Em resumo, palitos de madeira foram colocados sobre meio de cultura tradicional como Batata Dextrose Ágar (BDA), permitindo um pequeno espaço entre um e outro. Aproximadamente 1 ml de suspensão de conídios foram pipetados sobre os palitos. Placas de BDA foram incubadas entre 4 e 7 dias a 24^o^C antes da transferência. Palitos de madeira contendo micélio foram transferidos para placas de 150 mm através do gradiente de concentração do produto testado, onde cada placa permite o teste de oito diferentes isolados. Cada combinação de isolado e ingrediente ativo contou com duas placas, assim como no controle. Após o período de incubação de 72hrs, a uma temperatura de 24^o^C, ocorreu a avaliação. O processo de avaliação da sensibilidade é detalhado na (Figura\@ref(fig:figura3). 
Importante informar que as medidas de 'c' representadas na (Figura\@ref(fig:figura3) devem estar entre 20 e 64 mm. Em outras palavras, quaisquer medidas abaixo de 20 mm ou acima de 64 mm do centro da placa não devem ser contabilizados, pois nestas áreas a distribuição do fungicida não ocorre de forma homogênea @[Torres-Londoño2016].

(ref:figura3) Método da diluição em gradiente espiral. Preparo de inóculos em placa de BDA com palitos de madeira autoclavadas (A1), crescimento micelial do patógeno sobre os palitos após 7 dias de incubação a 24^o^C (A2), equipamento Eddy Jet 2W (Neutec Group Inc) com a placa de corante para observar o padrão de aplicação da solução estoque (B), oito palitos com crescimento micelial de diferentes isolados de **Colletotrichum fioriniae** em contato direto com o meio de cultura (C), placa sem fungicida (controle) com o crescimento micelial após 3 dias de incubação, onde 'a' representa a espessura de maior crescimento que deve ser tomada como futura referência para encontrar o ponto de gradiente espiral - brevemente, o ponto de gradiente espiral de cada isolado é obtido com a subtração da espessura do palito de madeira do valor de maior espessura de crescimento micelial no controle, ou valor referência, sendo este resultado dividido por 2. Subsequentemente, adiciona o valor da espessura do palito de madeira (D), placa de fungicida mostrando em 'b' o ponto de gradiente espiral onde o isolado foi inibido a 50%, e em 'c' mostra a distância entre o centro da placa e o ponto de inibição de 50% (E), sendo esta última medida utilizada no arquivo de dados para o cálculo da EC^50.

```{r figura3, echo = FALSE, fig.cap= '(ref:figura3)'}
knitr::include_graphics("paulo/figura3.tif")
```

Para esta nova análise, os seguintes pacotes necessitam ser carregados,'ECX','lattice', 'latticeExtra', 'grid', 'gridExtra', 'doBy', 'multcomp', 'reshape', 'reshape2', 'plyr', 'MASS', 'devtools' and 'agricolae'. No caso do pacote 'ECX', este pode ser encontrado em github.com no seguinte caminho: [EDITAR CAMINHO GITHUB DE GABRIEL]. 

```{r, message=FALSE}
##----------------------------------------------------------------------------      
## Pacotes

pkg <- c("ECX",
         "lattice", 
         "latticeExtra",
         "grid",
         "gridExtra",
         "doBy", 
         "multcomp",
         "reshape",
         "reshape2",
         "plyr",
         "MASS", 
         "devtools",
         "agricolae")

sapply(pkg, library, character.only=TRUE, logical.return=TRUE)

```

Nos comandos apresentados logo em seguida, serão selecionados os diretórios onde se encontram os arquivos de dados utilizados para este estudo (ref:dados2). Logo em seguida, serão criados uma nova categoria de dados 'pf' que unirá em uma única coluna os dados de população 'pop' e fungicida estudado 'fun'. Para garantir que os códigos descritos funcionem apropriadamente, a distância coletadas nas placas, coluna 'dis', devem ter o formato numérico 'as.numeric'. Por último, serão removidos os dados perdidos, assim como leituras de distâncias das placas que ficaram abaixo de 20 mm ou acima de 64 mm.

```{r dados2, echo = FALSE}
d2 <- read.txt("paulo/dados2.txt")
knitr::kable(head(d2, n = 10),
             caption = '(ref:dados2)',
             digits = c(NA, NA, 0, 0, NA, 2, 2),
             align = c("ccccccc"),
             row.names = FALSE)
```

```{r,include=FALSE}
#-----------------------------------------------------------------------------
# Seleção de diretório

rm(list=ls())
setwd()
list.files(pattern="*.txt")

#-----------------------------------------------------------------------------
# Carregamento de arquivo de dados 

da <- read.table("dados2.txt", header=TRUE, sep="\t", dec=".",
                 stringsAsFactors=FALSE)
#str(da)

#-----------------------------------------------------------------------------
# Edições de dados

da$pf <- with(da, interaction(pop, fun, sep="-", drop=TRUE))
  
da <- transform(da,
                dis=as.numeric(dis))

#str(da)

##----------------------------------------------------------------------------      
## Remoção de dados perdidos (NAs) e distâncias fora do range recomendado       

sum(is.na(da$dis)) 
da <- droplevels(da[complete.cases(da$dis),])

da=da[da$di>=20&da$dis<64,]
range(da$dis)

str(da)
head(da,10)

```

Para poder executar a função 'ECcal' corretamente será necessário a indicação dos nomes das colunas com suas respectivas funções dentro do comando a seguir, onde o arquivo de dados utilizado (ref:dados2) deverá incluir a coluna de isolado 'iso', população 'pop', repetição 'rep', solução estoque 'ss', fungicida 'fun', peso molecular do ingrediente ativo 'mw' e a distância da medida retirada da placa 'dis'. Recomenda-se o uso da página de internet PubChem para obter dados de peso molecular para as moléculas de interesse, informação esta disponível em (https://pubchem.ncbi.nlm.nih.gov/). Em seguida, ocorrerá o pareamento dos dados de isolado, população, fungicida com os valores de EC^50 recém gerado. Os nomes das colunas que formarão os resultados de sensibilidade podem ser modificados de acordo com a necessidade individual, como mostrado no comando 'names'. Uma tabela de Microsoft Excel em formato comma-separated values (csv) pode ser gerada neste momento, informando os valores de sensibilidade para cada isolado, população e fungicida listado, assim como mostra o último comando da seguinte célula de comandos.

```{r}
##----------------------------------------------------------------------------      
## Cálculo da EC50.

ec<-ECcal(da$dis, mw=da$mw, ppm=da$ss, product=da$fun, AH=2.6,iso=da$iso, info=F)
ec

db<- data.frame(da$iso,da$pop,da$fun,da$pf, ec)
names(db)<-c("iso","pop","fun","pf", "ec50")

str(db)
head(db,10)

##----------------------------------------------------------------------------
## Criar dados de Excel para valores de sensibilidade.
write.csv(db, row.names=F,'valores_ec50.csv')

```

Uma vez geradas as informações de EC^50, é possível realizar algumas comparações estatísticas para analisar as diferenças de sensibilidade entre populações. Nesse caso, serão exemplificados com o teste de Kolmogorov-smirnov, que determina as diferenças de médias entre populações através do valor de significância e D-estatístico.  

```{r}
##-----------------------------------------------------------------------------
## Kolmogorov-smirnov test for equal EC50 distribution.

str(db)
levels(db$pf)

##-----------------------------------------------------------------------------
## KS test for California

E <- split(db$ec50, f=db$pf)

ks.test(x=E[["BL-Bz"]], y=E[["EX-Bz"]])
ks.test(x=E[["BL-Bz"]], y=E[["BL-Fp"]])
ks.test(x=E[["BL-Bz"]], y=E[["EX-Fp"]])
ks.test(x=E[["EX-Bz"]], y=E[["BL-Fp"]])
ks.test(x=E[["EX-Bz"]], y=E[["EX-Fp"]])
ks.test(x=E[["BL-Fp"]], y=E[["EX-Fp"]])

```
Na figura (Figura\@ref(fig:figura4)), pode-se visualizar as densidades de distribuição das curvas de cada população de isolados estudados, assim como a frequência acumulada de suas sensibilidades a dois fungicidas testados. E assim finalizando este método de determinação da EC^50.   


(ref:figura4) Densidade de distribuição, incluindo valores de significância para 5% e D-estatístico (A) e frequência acumulada da sensibilidade de duas populações de **Colletotrichum fioriniae** em pistache. Onde, BL = população baseline (antes da exposição ao ingrediente ativo), EX = população exposta ao ingrediente ativo, Bz = bezovindiflupir, e Fp = fluopirame e fluopirame. 

```{r figura4, echo = FALSE, fig.cap= '(ref:figura4)'}
knitr::include_graphics("paulo/figura3.png")
```

```{r,fig.height=8, fig.width=8}
##----------------------------------------------------------------------------      
## Representação Gráfica das curvas de densidade da EC50

## Legenda da Figura contendo D-Statistico e valor de significância
exp <- list(  (BL-Bz:EX-Bz)~(D==0.17~~p==0.21),
              (BL-Bz:BL-Fp)~(D==0.31~~p==0.001),
              (BL-Bz:EX-Fp)~(D==0.29~~p==0.003),
              (EX-Bz:BL-Fp)~(D==0.23~~p==0.009),
              (EX-Bz:EX-Fp)~(D==0.15~~p==0.21),
              (BL-Fp:EX-Fp)~(D==0.36~~p==3.3*x10^-6))

## Densidade da distribuição da sensibilidade
p1 <-
    densityplot(~ec50,
                groups=pf,
                scales=list(x=list(log=10)),
                data=db,
                auto.key=list(columns=2), n=500,
                xlab=expression(log[10]~EC[50]),
                ylab="Density", plot.points="rug",
                xscale.components=xscale.components.log10.3,
                page=function(page){
                    grid.text("A", x=0.025, y=0.95)
                }, 
                panel=function(...){
                 panel.densityplot(...)
                 sapply(1:length(exp),
                        function(i){
                            grid.text(exp[[i]], x=0.025,
                                      y=unit(0.9, "npc")-
                                          unit(i-1, "lines"),
                                      just=c("left","centre"),
                                      gp=gpar(fontsize=9))
                        })
              })

## Frequência acumulada da sensibilidade
p2 <-
    ecdfplot(~ec50,
             groups=pf,
             scales=list(x=list(log=10)),
             data=db,
            # auto.key=list(columns=2),
             xlab=expression(log[10]~EC[50]),
             ylab="Cumulative relative frequency",
             xscale.components=xscale.components.log10.3,
             page=function(page){
                 grid.text("B", x=0.025, y=0.95)
             })

## Gerar Gráfico
grid.arrange(p1, p2, ncol=1)
#plot (p1, more=TRUE)

```

## Estimating isolate sensitivity by using the spline regression 

Para esta última descrição metodológica serão utilizados os pacotes 'lattice', 'latticeExtra', 'plyr', 'lme4', 'lmerTest', 'doBy', 'multcomp' e 'splines'.

```{r, message=FALSE}
#-----------------------------------------------------------------------------
# Pacotes

pkg <- c("lattice",
         "latticeExtra",
         "plyr",
         "lme4",
         "lmerTest",
         "doBy",
         "multcomp",
         "splines")

```

```{r dados3, echo = FALSE}

d3 <- read.txt("paulo/dados3.txt")
knitr::kable(head(d1, n = 10),
            caption = '(ref:dados3)',
            digits = c(0, NA, NA, NA, NA, 0, NA, 2, 0, 0, 0),
            align = c("ccccccccccc"),
            row.names = FALSE)

```

Na sequência, deverão ser selecionados os diretórios para acessar o arquivo de dados (ref:dados3) que serão transformados para formatos numérico 'as.numeric' e de fator 'factor'. A partir disto, os valores de diâmetro serão colocados em escala natural em milímitros, descontando-se o tamanho inicial do disco de micélio. Diâmetro médio (dm) e área da colônia (ar) também serão calculados.

```{r, message=FALSE}
#-----------------------------------------------------------------------------
# Seleção de diretório

list.files(pattern="*.txt")

#-----------------------------------------------------------------------------
# Carregamento de arquivo de dados

d3 <- read.table("dados3.txt", header=TRUE, sep="\t", dec=".",
                 stringsAsFactors=FALSE)

#-----------------------------------------------------------------------------
# Edições de dados

str(d3)

d3 <- transform(d3,
                pop=factor(pop),
                hed=factor(hed),
                tra=factor(tra),
                plot=factor(plot),
                fun=factor(fun),
                d1=as.numeric(d1),
                d2=as.numeric(d2))

sen <- within(d3, {
    # 500 é o tamanho do disco de micélio.
    d1 <- (d1 - 500)/100
    d2 <- (d2 - 500)/100
    dm <- (d1 + d2)/2
    ar <- pi * (dm/2)^2
})

str(sen)

#-----------------------------------------------------------------------------      
# População ao longo dos anos

xtabs(~pop + yr, data = sen)

```

O seguinte comando tem caráter exploratório. Demonstram os fatores de campo utilizados na coleta de dados durante o estudo. Onde a combinação entre ano da coleta (yr), severidade da poda de inverno (hed), tratamento de fungicida utilizado (tra) e fungicida testado in vitro (fun) foram coletados. Em seguida, observa-se a quantidade de dados perdidos durante o ensaio por isolado testado.

```{r, message=FALSE}
##----------------------------------------------------------------------------      
## Análise exploratória do número de observações por fator de combinação

with(sen,
     ftable(tapply(iso,
                   INDEX = list(yr, hed, tra, fun),
                   FUN = function(x) {
                       length(unique(x))
                   })))
```

```{r, message=FALSE}
##-----------------------------------------------------------------------------
# Isolados vs. leituras perdidas para fungicidas

xt <- xtabs(complete.cases(cbind(dm, dos)) ~ iso + fun,
            data = sen)
i <- xt == 0
sum(i)
xt[rowSums(i) > 0, ]

```

As cinco próximas representações gráficas, aqui descritas nos conjuntos de comando anotados de (a) à (e), exploram: a dispersão dos diâmetros coletados para todos isolados excluindo outliners (a); a dispersão entre os diâmetros coletados por isolados (b); a dispersão entre diâmetro médio e dose de fungicida (c). Onde em escala natural, exibe-se as curvas de inibições do diâmetro micelial médio para cada isolado. A dispersão entre o diâmetro médio e dose de fungicida por isolado em escala logarítmica (d), onde no mesmo gráfico observa-se uma clara assimetria nas curvas das doses de fungicidas. Além disso, pode-se observar a ausência de uma relação linear entre parâmetros mostrados, mesmo quando em escala log-log. E finalmente, a dispersão do diâmetro médio e dose fungicida transformada na raíz quinta (e). Para todas as representações gráficas, os ingredientes ativos de fluxapiroxade, fluopírame e pentiopirade são representados pelas cores azul, rosa e verde respectivamente.

```{r, fig.width=8, fig.height=8}
##-----------------------------------------------------------------------------
## Dispersão dos diâmetros coletados para todos isolados (a)
sen = sen[sen$d1<100&sen$d2<100,]

xyplot(d2 ~ d1,
       data = sen,
       title = "Dispersão entre diâmetros todos isolados",
       aspect = "iso",
       xlab = "Primeiro diâmetro (mm)",
       ylab = "Segundo diâmetro (mm)") +
    layer(panel.abline(a = 0, b = 1))

```

```{r,fig.height=8, fig.width=8}
##----------------------------------------------------------------------------      
# Dispersão dos diâmetros coletados por isolados (b) 

xyplot(d2 ~ d1 | iso,
       data = sen,
       title = "Dispersão entre diâmetros coletadas por isolados",
       aspect = "iso",
       groups = fun,
       strip = FALSE,
       as.table = TRUE,
       xlab = "Primeiro diâmetro (mm)",
       ylab = "Segundo diâmetro (mm)") +
    layer(panel.abline(a = 0, b = 1))

```

```{r,fig.height=8, fig.width=8}
##----------------------------------------------------------------------------      
# Dispersão dos diâmetros coletados por isolados (c)

xyplot(dm ~ dos | iso,
       data = sen,
       title = "Dispersão entre diâmetro médio e dose fungicida - escala natural",
       groups = fun,
       type = c("p", "a"),
       strip = FALSE,
       as.table = TRUE,
       ylab = "Diâmetro médio (mm)",
       xlab = "Dose de fungicida (µl)")

```

```{r,fig.height=8, fig.width=8}
##----------------------------------------------------------------------------      
# Dispersão dos diâmetros coletados por isolados - escala logarítmica (d)
# (Figure Chapter 3 n1)
xyplot(dm ~ dos | iso,
       scales = list(log = TRUE),
       data = sen,
       title = "Dispersão dos diâmetros coletados por isolados - escala logarítmica",
       groups = fun,
       type = c("p", "a"),
       strip = FALSE,
       as.table = TRUE,
       ylab = "log Diâmetro médio (mm)",
       xlab = "log Dose de fungicida (µl)")

```

```{r, message=FALSE}
##----------------------------------------------------------------------------      
# Dispersão do diâmetro médio e dose fungicida transformada na raíz quinta (e)
# (Figure Chapter 3 n2)
xyplot(dm ~ dos^0.2 | iso,
       data = sen,
       groups = fun,
       title = expression("Dispersão do diâmetro médio e dose fungicida na" ~ 5^o ~ "potência"),
       type = c("p", "a"),
       strip = FALSE,
       as.table = TRUE,
       ylab = "Diâmetro médio (mm)",
       xlab = expression("Raiz" ~ 5^o ~ "da dose de fungicida" ))
       
```

A transformação na raíz quinta, faz com que a distâncias entre doses sejam equalizadas. De fato, como é demonstrado, 0.2 foi o valor encontrado com a minimização da variância da distância entre doses (σ^2) e a transformação exponencial (p) da dose redimensionada a uma unidade de intervalo, descritas na seguinte equação \@ref(eq:equation1).

```{r,fig.height=8, fig.width=8}
#----------------------------------------------------------------------------- 
# Equação                                 
\begin{equation}
(\#eq:equation1) 
       z_{i} = x_i^p      
       u_{i} = \frac{z_{i} - min(z)}{max(z) - min(z)},  \rightarrow  u_{i}  \in  [0,1]      
       d_{i} = u_{i}+1 - u_{i}      
       \overline{d} = \sum_{i=1}^{k-1}d_{i}/k      
       \sigma^{2} = \sum_{i=1}^{k-1} \frac{(d_{i} - \overline{d})^2}{k-2}
\end{equation}  
```

Em que, $x$ é a dose em escala natural, $z$ é a dose transformada na quinta potência, $u$ é o dimensionamento para a unidade de intervalo, $d$ são as diferenças entre dose, $d¯$ é a diferença média, e $σ2$ é a variância da diferença.

```{r, message=FALSE}
##---------------------------------------------------------------------------- 
# Level único de dose de fungicida

x <- sort(unique(sen$dos))
x

```

```{r, message=FALSE}
##----------------------------------------------------------------------------    
# Variância da distância entre escala de dose e unidade de intervalo

esp <- function(p) {
    u <- x^p
    u <- (u - min(u))
    u <- u/max(u)
    var(diff(u))
}

# Melhoria do parâmetro de potência para melhor espaçamento entre doses

op <- optimize(f = esp, interval = c(0, 1))
op$minimum

```

Na seguinte representação gráfica exploratória, fica demonstrado a similar distribuição das doses, obtida com a transformação exponencial. Esta distribuição é desejada, porque assim reduz-se os problemas de alavancagem das curvas.

```{r,fig.height=8, fig.width=8}
##----------------------------------------------------------------------------      
# Gráfico exploratório das doses transformadas e igualmente espaçadas

p <- seq(0, 1, by = 0.01)
v <- sapply(p, esp)
plot(log(v) ~ p, type = "o")
abline(v = op$minimum)

```

Segundo @[Lawrence2001] a regressão spline é uma função construída de polinômios de terceiro grau que passam por um conjunto de nós (m+1). Estes nós abrangem o domínio observado do fator contínuo x, de modo que o conjunto de nós é
K=\left\{\xi_{0},\xi_{1},...,\xi_{m}\right\}.
Uma função s(x) é um spline cúbico se for formada por polinómios cúbicos s_i(x) em cada intervalo: \left[x_{i-1},x_{m}\right], i = 1,...,m.
Os fragmentos polinomiais cúbicos adjacentes devem se conectar de forma suavizada aos nós internos, de modo que restrições adicionais sejam feitas para resultar numa função composta e suave. Derivados contínuos asseguram que a função resultante seja a mais suave possível.
Para splines naturais, duas condições são necessárias
s_1^"\left(x\right)=0 , s_m^"\left(x\right)=0, 
ou seja, as partes das bordas não são cúbicas, mas sim lineares.

Os splines cúbicos naturais são utilizadas para estimar a concentração da meia dose efetiva de inibição micelial (EC50). Nesse contexto, o modelo não linear é geralmente aplicado, mas não foi encontrado um modelo não linear o suficientemente flexível para dar um bom ajuste a uma taxa de convergência satisfatória.

```{r, message=FALSE}
##----------------------------------------------------------------------------
## Uso de spline para estimar concentração da meia dose efetiva (CE50)

sen$iso <- factor(sen$iso, levels = sort(unique(sen$iso)))
sen$ue <- with(sen, interaction(iso, fun, drop = TRUE))
sen$doz <- sen$dos^0.2

str(sen)

# banco de dados sem dose
senu <- unique(subset(sen,
                      select = c(ue, iso, fun, tra,
                                 hed, pop, yr, plot)))

str(senu)
```

```{r, message=FALSE}
##----------------------------------------------------------------------------      
# Função para ajustar splines

fitting <- function(x) {
    x <- na.omit(x)
    if (nrow(x) > 4) {
        n0 <- lm(dm ~ ns(doz, df = 3), data = x)
        yfit <- predict(n0, newdata = pred)
        return(cbind(xfit = pred$doz, yfit = yfit))
    } else {
        NULL
    }
}

# Valores de doses para antecipar diâmetros
pred <- data.frame(doz = seq(0, max(sen$doz,na.rm = T), length.out = 30))

# Aplicar para todas unidades experimentais
res <- ddply(sen, .(ue), .fun = fitting)

# Juntar par `iso` e `fun`.
res <- merge(res, senu, by = "ue")

```

Sendo assim, os comandos abaixo estimam tanto a (CE~50~) quanto a área abaixo da curva de inibição, aqui chamada AACI. Também é disponibilizado um comando para exportar uma tabela de Microsoft Excel em formato comma-separated velues (*.CSV).

```{r, message=FALSE}
##---------------------------------------------------------------------------- 
# Estimando CE50 e AACI

get_ec50 <- function(x, y, interval = c(0, max(sen$doz,na.rm = T))) {
    fa <- approxfun(x = x, y = y)
    int <- integrate(fa,
                     lower = 0,
                     upper = max(sen$doz,na.rm = T))$value
    mxm <- optimize(fa, interval = interval, maximum = TRUE)
    ymid <- mxm[[2]]/2
    u <- try(uniroot(f = function(x) fa(x) - ymid,
                     interval = interval),
             silent = TRUE)
    if (class(u) == "try-error") {
        return(c(ec50 = NA, ev50 = NA, auc = int))
    }
    else {
        return(c(ec50 = u$root, ev50 = ymid, auc = int))
    }
}

# CE50 and AACI for each experimental unit.
ec <- ddply(res, .(ue), .fun = function(x) get_ec50(x$xfit, x$yfit))
str(ec)
head(ec)

```

```{r, message = FALSE}
##----------------------------------------------------------------------------      
## Criar uma tabela em excel (*.csv) com os valores calculados de sensibilidade

write.csv(ec, 'spline_valores_de_ec.csv')
```

```{r, message=FALSE}
##----------------------------------------------------------------------------    
# Proporção da CE50 e AUC não estimada
cbind(AUC = sum(is.na(ec$auc)),
      EC50 = sum(is.na(ec$ev50)))/nrow(ec)

```

A representação gráfica a seguir, demonstra a área abaixo da curva de inibição em função dos valores CE~50~, onde segundo @[Lichtemberg2017], existe uma significante e alta correlação entre estas duas variáveis, estimadas com r^2 = 82.5%.

```{r, message=FALSE}
# Scatter plot matrix para valores estimados

splom(ec[, -1], type = c("p", "smooth"), col.line = 2)

# Função entre AACI e CE50 para isolados com valor de sensibilidade estimados
xyplot(auc ~ ec50,
       data = ec,
       type = c("p", "smooth"),
       ylab = "Área abaixo da curva ajustada",
       xlab = expression("Estimado" ~ EC[50]))

##Figure 3: Area under the fitted curve as a function of the EC50 for those isolates where EC50 were estimated.
```


```{r, message=FALSE}
##----------------------------------------------------------------------------
# Correlação entre variáveis

cor(ec[, -1], use = "complete")

# Juntar o par `iso` e `fun`

ec <- merge(ec, senu, by = "ue", all = TRUE)
str(ec)

```

```{r, message=FALSE}
##----------------------------------------------------------------------------         
# Figura incluindo todos isolados com suas estimativas para CE50

L <- split(ec, ec$iso)

xyplot(dm ~ dos^0.2 | iso,
       data = sen,
       groups = fun,
       cex = 0.4,
       strip = FALSE,
       as.table = TRUE,
       auto.key = list(columns = 3,
                       title = "Fungicida In vitro todos isolados",
                       cex.title = 1.1),
       xlab = expression("Dose de fungicida In vitro na" ~ 5^o ~ "potência" ),
       ylab = "diâmetro médio (mm)") +
    as.layer(xyplot(yfit ~ xfit | iso,
                    groups = fun,
                    data = res,
                    type = "l")) +
    layer({
        with(L[[which.packet()]], {
            cl <- trellis.par.get()$superpose.symbol$col[as.integer(fun)]
            panel.segments(x0 = ec50,
                           y0 = ev50,
                           x1 = ec50,
                           y1 = 0,
                           col = "gray50")
            panel.segments(x0 = ec50,
                           y0 = ev50,
                           x1 = 0,
                           y1 = ev50,
                           col = "gray50")
            panel.points(x = ec50,
                         y = ev50,
                         pch = 19,
                         cex = 0.6,
                         col = cl)
        })
    })

#Figure 4: Mean diameter as function of fungicide dose 5th root for each isolate. Solid line is the natural cubic spline fitted for each fungicide in each isolate. Gray straight line indicates the EC50 on each curve.
```

Finalizando esta metodologia, é possível criar uma representação gráfica onde se demonstra, para 40 isolados, o diâmetro médio em função da dose de fungicida transformada na raíz quinta para cada isolado. Onde, a linha sólida é o spline cúbico natural, ajustado para cada fungicida em cada isolado. Em linhas sólidas cinzas indicam o valor de sensibilidade para cada curva.  

```{r, message=FALSE}
##----------------------------------------------------------------------------
# Figura incluindo apenas 40 isolados

set.seed(123)
i <- sample(levels(sen$iso), size = 40)
i <- as.character(sort(as.integer(i)))
L <- L[i]

xyplot(dm ~ dos^0.2 | iso,
       data = sen,
       subset = iso %in% i,
       groups = fun,
       cex = 0.4,
       strip = FALSE,
       as.table = TRUE,
       auto.key = list(columns = 3,
                       title = "Fungicida In vitro n=40",
                       cex.title = 1.1),
       xlab = expression("Raiz" ~ 5^o ~ "da dose de fungicida" ),
       ylab = "diâmetro médio (mm)") +
    as.layer(xyplot(yfit ~ xfit | iso,
                    groups = fun,
                    data = res,
                    subset = iso %in% i,
                    type = "l")) +
    layer({
        with(L[[which.packet()]], {
            cl <- trellis.par.get()$superpose.symbol$col[as.integer(fun)]
            panel.segments(x0 = ec50,
                           y0 = ev50,
                           x1 = ec50,
                           y1 = 0,
                           col = "gray50")
            panel.segments(x0 = ec50,
                           y0 = ev50,
                           x1 = 0,
                           y1 = ev50,
                           col = "gray50")
            panel.points(x = ec50,
                         y = ev50,
                         pch = 19,
                         cex = 0.6,
                         col = cl)
        })
    })

#Figure 5: Mean diameter as function of fungicide dose 5th root for a random sample of isolates. Solid line is the natural cubic spline fitted for each fungicide in each isolate. Gray straight line indicates the EC50 on each curve.

```

## Informações adicionais de pacotes utilizados

Ao final de cada script, é sugerido a utilização dos seguintes comandos para a identificação das versões de pacotes utilizados e plataforma de R-software utilizada, assim como a correta citação do R em publicações e a data e hora que as analises foram realizadas.

```{r}
##----------------------------------------------------------------------------
## Versions.

sessionInfo()

##-----------------------------------------------------------------------------
## Citation.

citation()

##-----------------------------------------------------------------------------
## Last modification.

Sys.time()

```
